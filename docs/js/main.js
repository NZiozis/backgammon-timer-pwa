const MATCH_PARAMETERS_KEY="matchParameters",GAME_STATE_KEY="gameState",ONE_SECOND_IN_MS=1e3,TEN_MINUTES_IN_MS=6e5,TEN_SECONDS_IN_MS=1e4,PlayerTurn={NEUTRAL:"NEUTRAL",PLAYER_ONE:"PLAYER_ONE",PLAYER_TWO:"PLAYER_TWO"},CubeOwnership={NEUTRAL:"NEUTRAL",PLAYER_ONE:"PLAYER_ONE",PLAYER_TWO:"PLAYER_TWO"},StartType={ALWAYS_RANDOM:"ALWAYS_RANDOM",FIRST_GAME_RANDOM:"FIRST_GAME_RANDOM",PLAYER_THAT_CLICKS:"PLAYER_THAT_CLICKS"};function setDefaultHide(e,t){t?e.forEach(function(n){const o=[...n.classList];o.includes("default_hidden")||(o.push("default_hidden"),n.classList=o.join(" "))}):e.forEach(function(n){const o=[...n.classList].filter(a=>a!=="default_hidden");n.classList=o.join(" ")})}const matchParameters={playerOneName:"Player One",playerTwoName:"Player Two",useCube:!0,useDice:!0,useTimer:!0,startType:StartType.ALWAYS_RANDOM,totalGameTimeMs:6e5,reserveTimeMs:1e4,scoreLimit:7},handleMatchParametersChange={set(e,t,n){const o=document.querySelector("#player_one #main_ui"),a=document.querySelector("#player_two #main_ui");if(t==="playerOneName")document.getElementById("player_one_name").innerText=n;else if(t==="playerTwoName")document.getElementById("player_two_name").innerText=n;else if(t==="totalGameTimeMs")document.getElementById("player_one_total_time").innerText=formatTotalTime(n),document.getElementById("player_two_total_time").innerText=formatTotalTime(n);else if(t==="reserveTimeMs")document.getElementById("player_one_reserve_time").innerText=formatReserveTime(n),document.getElementById("player_two_reserve_time").innerText=formatReserveTime(n);else if(t==="scoreLimit")document.getElementById("sidebar_game_info").innerText=`Game to ${n}`;else if(t==="useCube"){const l=Array.from(document.getElementsByClassName("double_button")),r=document.getElementById("midline");n?(setDefaultHide([r],!1),setDefaultHide(l,!1)):(setDefaultHide([r],!0),setDefaultHide(l,!0))}else if(t==="useDice"){const l=Array.from(document.getElementsByClassName("roll_button")),r=Array.from(document.getElementsByClassName("done_main_ui")),c=Array.from(document.getElementsByClassName("done_roll_ui"));n?(setDefaultHide([...l,...c],!1),setDefaultHide(r,!0)):(setDefaultHide([...l,...c],!0),setDefaultHide(r,!1))}else if(t==="useTimer"){const l=Array.from(document.getElementsByClassName("player_time_container")),r=Array.from(document.getElementsByClassName("player_infinity"));n?(setDefaultHide(r,!0),setDefaultHide(l,!1)):(setDefaultHide(r,!1),setDefaultHide(l,!0))}else t==="startType"||console.warn(`Failed to account for match parameter ${t}`);return Reflect.set(e,t,n)}},observedMatchParameters=new Proxy(matchParameters,handleMatchParametersChange);function resetMatchParameters(){observedMatchParameters.playerOneName="Player One",observedMatchParameters.playerTwoName="Player Two",observedMatchParameters.useCube=!0,observedMatchParameters.useDice=!0,observedMatchParameters.useTimer=!0,observedMatchParameters.startType=StartType.ALWAYS_RANDOM,observedMatchParameters.totalGameTimeMs=6e5,observedMatchParameters.reserveTimeMs=1e4,observedMatchParameters.scoreLimit=7}const gameState={currentPlayerTurn:PlayerTurn.NEUTRAL,currentGameValue:1,cubeOwnership:CubeOwnership.NEUTRAL,playerOneGames:0,playerOneScore:0,playerOneTotalTimeRemainingMs:6e5,playerOneReserveTimeRemainingMs:1e4,playerOneTimeoutId:null,playerTwoGames:0,playerTwoScore:0,playerTwoTotalTimeRemainingMs:6e5,playerTwoReserveTimeRemainingMs:1e4,playerTwoTimeoutId:null,forceStopTimer:!0},handleGameStateChange={set(e,t,n){const o=document.querySelector("#player_one #main_ui"),a=document.querySelector("#player_two #main_ui");if(t==="forceStopTimer"&&n===!0)clearTimeout(e.playerTwoTimeoutId),e.playerTwoTimeoutId=null,clearTimeout(e.playerOneTimeoutId),e.playerOneTimeoutId=null;else if(t==="currentPlayerTurn"){const l=gameState.currentPlayerTurn===PlayerTurn.NEUTRAL;n===PlayerTurn.PLAYER_ONE?(o.style.display="flex",a.style.display="none",l||(document.querySelector("#player_two #roll_action_ui").style.display="none")):n===PlayerTurn.PLAYER_TWO&&(o.style.display="none",a.style.display="flex",l||(document.querySelector("#player_one #roll_action_ui").style.display="none"))}else if(t==="cubeOwnership"){const l=document.getElementById("midline"),r=document.getElementById("doubling_cube");switch(n){case CubeOwnership.NEUTRAL:r.style.transform="rotate(90deg)",l.style.justifyContent="center";break;case CubeOwnership.PLAYER_ONE:r.style.transform="rotate(180deg)",l.style.justifyContent="start";break;case CubeOwnership.PLAYER_TWO:r.style.transform="rotate(0deg)",l.style.justifyContent="end";break}if(n!==CubeOwnership.NEUTRAL)switch(e.currentPlayerTurn){case PlayerTurn.PLAYER_ONE:o.style.display="flex",o.querySelector(".double_button").style.display="none",a.querySelector(".double_button").style.display="block",document.querySelector("#player_two #double_action_ui").style.display="none";break;case PlayerTurn.PLAYER_TWO:a.style.display="flex",o.querySelector(".double_button").style.display="block",a.querySelector(".double_button").style.display="none",document.querySelector("#player_one #double_action_ui").style.display="none";break;case PlayerTurn.NEUTRAL:console.error("Turn cannot be neutral if cube ownership is not neutral");break}}else if(t==="currentGameValue"){const l=document.getElementById("doubling_cube");l.innerText=n===1?"64":n}else t==="playerOneScore"?(document.getElementById("player_one_score").innerText=n,n>=observedMatchParameters.scoreLimit&&showAlert(`${observedMatchParameters.playerOneName} wins`,`${observedMatchParameters.playerOneName} won the game to ${observedMatchParameters.scoreLimit}`,!0,()=>{fullReset()},!0,void 0)):t==="playerOneGames"?document.getElementById("player_one_games").innerText=formatGamesValue(n):t==="playerTwoScore"?(document.getElementById("player_two_score").innerText=n,n>=observedMatchParameters.scoreLimit&&showAlert(`${observedMatchParameters.playerTwoName} wins`,`${observedMatchParameters.playerTwoName} won the game to ${observedMatchParameters.scoreLimit}`,!1,()=>{fullReset()},!0,void 0)):t==="playerTwoGames"?document.getElementById("player_two_games").innerText=formatGamesValue(n):t==="playerOneReserveTimeRemainingMs"?document.getElementById("player_one_reserve_time").innerText=formatReserveTime(n):t==="playerTwoReserveTimeRemainingMs"?document.getElementById("player_two_reserve_time").innerText=formatReserveTime(n):t==="playerOneTotalTimeRemainingMs"?document.getElementById("player_one_total_time").innerText=formatTotalTime(n):t==="playerTwoTotalTimeRemainingMs"&&(document.getElementById("player_two_total_time").innerText=formatTotalTime(n));return Reflect.set(e,t,n)}},observedGameState=new Proxy(gameState,handleGameStateChange);function resetGameState(){observedGameState.forceStopTimer=!0,observedGameState.currentPlayerTurn=PlayerTurn.NEUTRAL,observedGameState.currentGameValue=1,observedGameState.cubeOwnership=CubeOwnership.NEUTRAL,observedGameState.playerOneGames=0,observedGameState.playerOneScore=0,observedGameState.playerOneTotalTimeRemainingMs=observedMatchParameters.totalGameTimeMs,observedGameState.playerOneReserveTimeRemainingMs=observedMatchParameters.reserveTimeMs,observedGameState.playerTwoGames=0,observedGameState.playerTwoScore=0,observedGameState.playerTwoTotalTimeRemainingMs=observedMatchParameters.totalGameTimeMs,observedGameState.playerTwoReserveTimeRemainingMs=observedMatchParameters.reserveTimeMs}function pauseGame(){observedGameState.forceStopTimer=!0,Array.from(document.getElementsByClassName("play_button")).forEach(function(e){e.style.display="block"}),Array.from(document.getElementsByClassName("pause_button")).forEach(function(e){e.style.display="none"}),document.getElementById("unclickable_overlay").style.display="block"}function resumeGame(){observedGameState.forceStopTimer=!1,Array.from(document.getElementsByClassName("play_button")).forEach(function(e){e.style.display="none"}),Array.from(document.getElementsByClassName("pause_button")).forEach(function(e){e.style.display="block"}),document.getElementById("unclickable_overlay").style.display="none",gameState.currentPlayerTurn!==PlayerTurn.NEUTRAL&&setupTimerForPlayer(gameState.currentPlayerTurn===PlayerTurn.PLAYER_ONE)}function loadStateFromLocalStorage(e){try{const t=localStorage.getItem(e);return t===null?void 0:JSON.parse(t)}catch(t){console.error("Error loading state from local storage:",t);return}}function saveStateToLocalStorage(e,t){try{const n=JSON.stringify(t);localStorage.setItem(e,n)}catch(n){console.error("Error saving state to local storage:",n)}}function togglePlayerTurn(){console.assert(gameState.currentPlayerTurn!==PlayerTurn.NEUTRAL,"Trying to toggle player turn when no player active"),gameState.currentPlayerTurn===PlayerTurn.PLAYER_ONE?observedGameState.currentPlayerTurn=PlayerTurn.PLAYER_TWO:observedGameState.currentPlayerTurn=PlayerTurn.PLAYER_ONE}function formatGamesValue(e){return`(${e})`}function formatReserveTime(e){return`(${String(e/1e3).padStart(2,"0")})`}function formatTotalTime(e){const t=String(Math.trunc(e/6e4)).padStart(2,"0"),n=String(e%6e4/1e3).padStart(2,"0");return`${t}:${n}`}function isFirstGame(){return gameState.playerOneScore===0&&gameState.playerTwoScore===0}function isPlayerOneUIElement(e){let t=e;for(;!t.dataset.hasOwnProperty("playerId");)t=t.parentElement,t===null&&console.error("Unable to find which player clicked");return t.dataset.playerId==="1"}function onClickConcede(e){setupConcedeDialog(e),document.getElementById("concede_dialog").showModal()}function onClickSettings(){setupSettingsDialog(),document.getElementById("settings_dialog").showModal()}function showAlert(e,t,n,o,a,l){const r=document.getElementById("alert_dialog");document.getElementById("alert_title").innerText=e,document.getElementById("alert_content").innerText=t,n&&(r.style.transform="rotate(180deg)");const c=new AbortController,i=c.signal,s=document.getElementById("close_alert");a?s.style.display="none":(s.style.display="block",s.addEventListener("click",m=>{r.close(),l()},{signal:i})),document.getElementById("ok_alert").addEventListener("click",m=>{r.close(),o()},{signal:i}),r.addEventListener("close",()=>{r.style.transform="rotate(0deg)",c.abort()},{once:!0}),r.showModal()}function alertToAcceptConcede(e,t){const n=e?observedMatchParameters.playerOneName:observedMatchParameters.playerTwoName;showAlert(`Accept ${t} points?`,`${n} is offering to concede the game with ${t} points. Do you accept?`,!e,()=>{handlePlayerWin(!e,t),document.getElementById("concede_dialog").close()},!1,()=>{document.getElementById("concede_dialog").close()})}function setupSidebar(){Array.from(document.getElementsByClassName("concede_button")).forEach(function(e){e.onclick=()=>onClickConcede(isPlayerOneUIElement(e))}),Array.from(document.getElementsByClassName("settings_button")).forEach(function(e){e.onclick=onClickSettings}),Array.from(document.getElementsByClassName("play_button")).forEach(function(e){e.onclick=resumeGame}),Array.from(document.getElementsByClassName("pause_button")).forEach(function(e){e.onclick=pauseGame})}function setupConcedeDialog(e){const t=document.getElementById("concede_dialog");e&&(t.style.transform="rotate(180deg)");const n=new AbortController,o=n.signal,a=document.getElementById("concede_one_match");a.innerText=`Concede ${gameState.currentGameValue}`,a.addEventListener("click",i=>{alertToAcceptConcede(e,1)},{signal:o});const l=document.getElementById("concede_two_match");l.innerText=`Concede ${gameState.currentGameValue*2}`,l.addEventListener("click",i=>{alertToAcceptConcede(e,2)},{signal:o});const r=document.getElementById("concede_three_match");r.innerText=`Concede ${gameState.currentGameValue*3}`,r.addEventListener("click",i=>{alertToAcceptConcede(e,3)},{signal:o}),document.getElementById("concede_game").addEventListener("click",i=>{handlePlayerWin(!e,1,!0),t.close()},{signal:o}),document.getElementById("close_concede").addEventListener("click",i=>{t.close()},{signal:o}),t.addEventListener("close",()=>{t.style.transform="rotate(0deg)",n.abort()},{once:!0})}function setupSettingsDialog(){const e=document.getElementById("settings_dialog"),t=document.getElementById("settings_form"),n=document.getElementById("close_settings"),o=document.getElementById("save_settings");document.getElementById(observedMatchParameters.startType).selected=!0,document.getElementById("useCube").checked=observedMatchParameters.useCube,document.getElementById("useDice").checked=observedMatchParameters.useDice,document.getElementById("useTimer").checked=observedMatchParameters.useTimer,document.getElementById("scoreLimit").value=observedMatchParameters.scoreLimit,document.getElementById("playerOneName").value=observedMatchParameters.playerOneName,document.getElementById("playerTwoName").value=observedMatchParameters.playerTwoName;const a=observedMatchParameters.totalGameTimeMs;document.getElementById("formTotalGameTimeMinutes").value=Math.floor(a/6e4),document.getElementById("formTotalGameTimeSeconds").value=a%6e4/1e3,document.getElementById("formReserveTimeSeconds").value=observedMatchParameters.reserveTimeMs/1e3;const l=new AbortController,r=l.signal;n.addEventListener("click",()=>{e.close()},{signal:r}),o.addEventListener("click",c=>{showAlert("Change settings?","Changing the settings will reset the game. Are you sure you want to change?",!1,()=>{if(c.preventDefault(),!t.checkValidity()){t.reportVailidity(),showFeedback("Please fill out all fields in the form",!1);return}let i=0;for(const s of t.elements)s.name&&s.type!=="submit"&&s.type!=="button"&&(s.type==="checkbox"?observedMatchParameters[s.name]=s.checked:s.name==="formTotalGameTimeMinutes"?i+=+s.value*60:s.name==="formTotalGameTimeSeconds"?i+=+s.value:s.name==="formReserveTimeSeconds"?observedMatchParameters.reserveTimeMs=+s.value*1e3:s.name==="scoreLimit"?observedMatchParameters.scoreLimit=+s.value:observedMatchParameters[s.name]=s.value);observedMatchParameters.totalGameTimeMs=i*1e3,saveStateToLocalStorage(MATCH_PARAMETERS_KEY,observedMatchParameters),fullReset(),e.close()},!1,()=>{e.close()})},{signal:r}),e.addEventListener("close",()=>{l.abort()},{once:!0})}function onClickDone(e){togglePlayerTurn(),setupTimerForPlayer(!e)}function onClickDouble(e){const t=e?document.getElementById("player_one"):document.getElementById("player_two"),n=e?document.getElementById("player_two"):document.getElementById("player_one");t.querySelector("#main_ui").style.display="none",n.querySelector("#double_action_ui").style.display="flex",n.querySelector("#offered_cube").innerText=gameState.currentGameValue*2,document.getElementById("doubling_cube").style.display="none",setupTimerForPlayer(!e)}function onClickDoubleTake(e){observedGameState.currentGameValue=gameState.currentGameValue*2,observedGameState.cubeOwnership=e?CubeOwnership.PLAYER_ONE:CubeOwnership.PLAYER_TWO,document.getElementById("doubling_cube").style.display="flex",setupTimerForPlayer(!e)}function onClickDoubleDrop(e){handlePlayerWin(!e)}function onClickRoll(e){const t=e?document.getElementById("player_one"):document.getElementById("player_two");t.querySelector("#main_ui").style.display="none",t.querySelector("#roll_action_ui").style.display="flex",t.querySelector("#dice_one_span").innerText=Math.floor(Math.random()*6)+1,t.querySelector("#dice_two_span").innerText=Math.floor(Math.random()*6)+1}function onClickStart(e){observedGameState.forceStopTimer=!1,Array.from(document.getElementsByClassName("start_ui")).forEach(function(n){n.style.display="none"});let t;observedMatchParameters.startType===StartType.ALWAYS_RANDOM||observedMatchParameters.startType===StartType.FIRST_GAME_RANDOM&&isFirstGame()?t=Math.floor(Math.random()*10)%2===0:t=e,observedGameState.currentPlayerTurn=t?PlayerTurn.PLAYER_ONE:PlayerTurn.PLAYER_TWO,setupTimerForPlayer(t)}function setupMainButtons(){Array.from(document.getElementsByClassName("start_button")).forEach(function(e){e.onclick=()=>onClickStart(isPlayerOneUIElement(e))}),Array.from(document.getElementsByClassName("double_drop_button")).forEach(function(e){e.onclick=()=>onClickDoubleDrop(isPlayerOneUIElement(e))}),Array.from(document.getElementsByClassName("double_take_button")).forEach(function(e){e.onclick=()=>onClickDoubleTake(isPlayerOneUIElement(e))}),Array.from(document.getElementsByClassName("double_button")).forEach(function(e){e.onclick=()=>onClickDouble(isPlayerOneUIElement(e))}),Array.from(document.getElementsByClassName("roll_button")).forEach(function(e){e.onclick=()=>onClickRoll(isPlayerOneUIElement(e))}),Array.from(document.getElementsByClassName("done_button")).forEach(function(e){e.onclick=()=>onClickDone(isPlayerOneUIElement(e))})}function setupTimerForPlayer(e){if(!observedMatchParameters.useTimer)return;let t;function n(){if(gameState.forceStopTimer)return;e?gameState.playerOneReserveTimeRemainingMs>0?observedGameState.playerOneReserveTimeRemainingMs-=1e3:(observedGameState.playerOneTotalTimeRemainingMs-=1e3,gameState.playerOneTotalTimeRemainingMs<=0&&handlePlayerWin(!1,1,!0)):gameState.playerTwoReserveTimeRemainingMs>0?observedGameState.playerTwoReserveTimeRemainingMs-=1e3:(observedGameState.playerTwoTotalTimeRemainingMs-=1e3,gameState.playerTwoTotalTimeRemainingMs<=0&&handlePlayerWin(!0,1,!0));const l=Date.now()-t;t+=1e3;const r=setTimeout(n,Math.max(0,1e3-l));e?observedGameState.playerOneTimeoutId=r:observedGameState.playerTwoTimeoutId=r}t=Date.now()+1e3;const o=setTimeout(n,1e3);e?(observedGameState.playerOneTimeoutId=o,clearTimeout(gameState.playerTwoTimeoutId),observedGameState.playerTwoTimeoutId=null,observedGameState.playerTwoReserveTimeRemainingMs=observedMatchParameters.reserveTimeMs):(observedGameState.playerTwoTimeoutId=o,clearTimeout(gameState.playerOneTimeoutId),observedGameState.playerOneTimeoutId=null,observedGameState.playerOneReserveTimeRemainingMs=observedMatchParameters.reserveTimeMs)}function handlePlayerWin(e,t=1,n=!1){const o=gameState.currentGameValue*t;if(e){if(observedGameState.playerOneGames+=1,observedGameState.playerOneScore+=o,n){observedGameState.playerOneScore+=+observedMatchParameters.scoreLimit;return}}else if(observedGameState.playerTwoGames+=1,observedGameState.playerTwoScore+=o,n){observedGameState.playerTwoScore+=+observedMatchParameters.scoreLimit;return}observedGameState.currentGameValue=1,observedGameState.cubeOwnership=CubeOwnership.NEUTRAL,observedGameState.currentPlayerTurn=PlayerTurn.NEUTRAL,document.getElementById("doubling_cube").style.display="flex",clearTimeout(gameState.playerTwoTimeoutId),observedGameState.playerTwoTimeoutId=null,clearTimeout(gameState.playerOneTimeoutId),observedGameState.playerOneTimeoutId=null,document.getElementById("player_two_reserve_time").innerText=formatReserveTime(observedMatchParameters.reserveTimeMs),document.getElementById("player_one_reserve_time").innerText=formatReserveTime(observedMatchParameters.reserveTimeMs),Array.from(document.getElementsByClassName("main_ui")).forEach(function(a){a.style.display="none",a.querySelector(".double_button").style.display="block"}),Array.from(document.getElementsByClassName("roll_action_ui")).forEach(function(a){a.style.display="none"}),Array.from(document.getElementsByClassName("double_action_ui")).forEach(function(a){a.style.display="none"}),Array.from(document.getElementsByClassName("start_ui")).forEach(function(a){a.style.display="flex"})}function fullReset(){resetGameState(),resetUI()}function resetUI(){Array.from(document.getElementsByClassName("main_ui")).forEach(function(e){e.style.display="none"}),Array.from(document.getElementsByClassName("roll_action_ui")).forEach(function(e){e.style.display="none"}),Array.from(document.getElementsByClassName("double_action_ui")).forEach(function(e){e.style.display="none"}),Array.from(document.getElementsByClassName("start_ui")).forEach(function(e){e.style.display="flex"})}document.addEventListener("DOMContentLoaded",()=>{resetMatchParameters();const e=loadStateFromLocalStorage(MATCH_PARAMETERS_KEY);for(const n in e)observedMatchParameters[n]=e[n];resetGameState();const t=loadStateFromLocalStorage(GAME_STATE_KEY);for(const n in t)observedGameState[n]=t[n];setupSidebar(),setupMainButtons()});
